{% extends "layout/app.layout.html.twig" %}
{% block title %} Machines {% endblock %}

{% block content %}
    <div class="row flex-grow">
        <div class="col-md-12">
            {% for message in app.flashes('success') %}
                <div class="alert alert-success">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
        <div class="col-12 grid-margin stretch-card">
            <div class="card card-rounded">
                <div class="card-body">
                    <div class="d-sm-flex">
                        <div>
                            <h2 class="card-title card-title-dash">Selectionner une Machine</h2>
                        </div>
                    </div>
                    <div class="mt-4">
                       {% include "client/machine/choice.html.twig" %}
                    </div>
                </div>
            </div>
        </div>
        <div class="col-12 grid-margin stretch-card">
            <div class="card card-rounded">
                <div class="card-body">
                    <div class="d-sm-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="card-title card-title-dash">Machines</h2>
                        </div>
                        <div>
                            <input type="text" class="form-control" id="tableFilter" placeholder="Filtrer par texte..." />
                        </div>

                    </div>
                    <div class="table-responsive mt-1">
                        <table class="table select-table" id="myTable">
                            <thead>
                                <tr>
                                    <th>Numéro d'identification</th>
                                    <th>Nom</th>
                                    <th>Marque</th>
                                    <th>Temp d'usage</th>
                                    <th>Seuil de maintenance</th>
                                    <th>actions</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for machine in user_machines %} 
                                <tr>
                                    <td>
                                        {{machine.numeroIdentification}}
                                    </td>
                                    <td>
                                       {{machine.nom}}
                                    </td>
                                    <td>
                                      {{machine.marque}}  
                                    </td>
                                    <td>
                                       {{machine.tempUsage}}
                                    </td>
                                    <td>
                                      {{machine.seuilMaintenance}}  
                                    </td>
                                    <td>
                                        <div class="d-flex gap-2">                                            
                                            <button type="button" 
                                                    class="btn btn-danger btn-sm delete-machine-btn" 
                                                    title="Supprimer"
                                                    data-machine-id="{{ machine.id }}"
                                                    data-machine-name="{{ machine.nom}}"
                                            >
                                                <i class="mdi mdi-delete"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmationModal" tabindex="-1" aria-labelledby="deleteConfirmationModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmationModalLabel">Confirmation de suppression</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Êtes-vous sûr de vouloir supprimer la machine <span id="machineName"></span> ?</p>
                    <p class="text-danger">Cette action est irréversible.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <form id="deleteForm" method="POST" action="" style="display: inline;">
                        <button type="submit" class="btn btn-danger">Supprimer</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
{% endblock %}
{% block script %}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
        // Code pour la suppression d'une machine
            if (typeof jQuery !== 'undefined') {
                $('.delete-machine-btn').click(function() {
                    var machineId = $(this).data('machine-id');
                    var machineName = $(this).data('machine-name');
                    $('#machineName').text(machineName);
                    $('#deleteForm').attr('action', "{{path('app_delete_user_machine', {'machineId': 'MACHINEID'})}}".replace('MACHINEID', machineId));
                    $('#deleteConfirmationModal').modal('show');
                });
                $('.btn-secondary').click(function() {
                    $('#deleteConfirmationModal').modal('hide');
                });
            } else {
                console.error('jQuery is not loaded!');
            }

        // Code pour le tri des machines
            const headers = document.querySelectorAll('th');
            headers.forEach(header => {
                const icon = document.createElement('i');
                icon.classList.add('mdi', 'mdi-arrow-up-down'); 
                header.appendChild(icon);
                header.addEventListener('click', function() {
                    const table = header.closest('table');
                    const rows = Array.from(table.querySelectorAll('tr:nth-child(n+2)')); 
                    const index = Array.from(header.parentElement.children).indexOf(header);
                    const ascending = header.classList.contains('ascending');
                    // Trier les lignes
                    rows.sort((rowA, rowB) => {
                        const cellA = rowA.children[index].textContent.trim().toLowerCase(); 
                        const cellB = rowB.children[index].textContent.trim().toLowerCase();
                        if (ascending) {
                            return cellA > cellB ? 1 : (cellA < cellB ? -1 : 0); 
                        } else {
                            return cellA < cellB ? 1 : (cellA > cellB ? -1 : 0); 
                        }
                    });
                    // Réorganiser les lignes dans le tableau
                    rows.forEach(row => table.appendChild(row));
                    // Mettre à jour les icônes de tri
                    headers.forEach(h => {
                        h.classList.remove('ascending', 'descending');
                        const icon = h.querySelector('i');
                        if (icon) icon.classList.remove('mdi-arrow-up', 'mdi-arrow-down');
                    });
                    // Ajouter l'icône et les classes de tri
                    if (ascending) {
                        header.classList.add('descending');
                        icon.classList.add('mdi-arrow-down');
                    } else {
                        header.classList.add('ascending');
                        icon.classList.add('mdi-arrow-up');
                    }
                });
            });


        // Code pour le tri des machines
            const filterInput = document.getElementById('tableFilter');
            filterInput.addEventListener('input', function () {
                const filterText = filterInput.value.toLowerCase(); // Convertir le texte de filtre en minuscule
                const rows = document.querySelectorAll('#myTable tbody tr'); // Sélectionner toutes les lignes du tableau
                rows.forEach(row => {
                    const cells = row.querySelectorAll('td');
                    let matches = false;
                    // Vérifier si le texte de chaque cellule de la ligne correspond au texte de filtre
                    cells.forEach(cell => {
                        if (cell.textContent.toLowerCase().includes(filterText)) {
                            matches = true; // Si une cellule contient le texte, la ligne correspond au filtre
                        }
                    });
                    // Afficher ou masquer la ligne en fonction de la correspondance
                    if (matches) {
                        row.style.display = ''; // Afficher la ligne
                    } else {
                        row.style.display = 'none'; // Masquer la ligne
                    }
                });
            });

        });
    </script>
{% endblock %}
